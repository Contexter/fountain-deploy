Alembic is a database migration tool for SQLAlchemy, a popular SQL toolkit and Object-Relational Mapping (ORM) library for Python. Alembic is designed to allow for version control of your database schema, enabling you to manage and apply changes to your database's structure over time. This is particularly useful in a team development environment, where multiple developers might be making changes to the database schema.

With Alembic, you can:

- Generate migration scripts automatically, based on changes detected in your SQLAlchemy models.
- Apply migrations to your database incrementally, moving it from one version to another.
- Maintain a history of changes made to the database schema, allowing you to revert to previous versions if necessary.

It works by keeping track of "versions" of the database schema, using a linear or branched model of version control. Each version represents a change or a series of changes to the database schema. These changes are written in Python scripts, allowing you to leverage the full power of Python to manage database migrations.

# An alembic example: 

Certainly! Here's a simplified example of how you might use Alembic for managing database migrations in a project that uses SQLAlchemy.

### Step 1: Initialize Alembic

First, you need to initialize Alembic in your project. This creates an `alembic` directory with configuration files and a script directory for your migration files.

You can initialize Alembic by running:

```shell
alembic init alembic
```

### Step 2: Configure Alembic

Edit the `alembic.ini` file to configure the SQLALCHEMY database URL, pointing it to your database.

```ini
sqlalchemy.url = driver://user:pass@localhost/dbname
```

You'll also need to edit the `env.py` file within the `alembic` directory to import your SQLAlchemy base and target metadata.

```python
from myapp.models import Base  # Import your SQLAlchemy Base
target_metadata = Base.metadata
```

### Step 3: Create a Migration Script

Generate an initial migration script. Alembic can autogenerate changes by comparing your database models with the current state of the database. However, it's recommended to review scripts for accuracy.

```shell
alembic revision --autogenerate -m "Initial migration"
```

This command creates a migration script in the `alembic/versions` directory.

### Step 4: Review the Migration Script

Open the generated script in `alembic/versions` and review the `upgrade()` and `downgrade()` functions to make sure they correctly represent the changes you intend to make to your database schema.

### Step 5: Apply the Migration

To apply the migration to your database, run:

```shell
alembic upgrade head
```

This command applies all pending migrations up to the "head", which is the latest revision.

### Example of a Migration Script

Migration scripts have `upgrade()` and `downgrade()` functions, which Alembic runs to apply or revert migrations, respectively.

Here's an example of a simple migration script that adds a "users" table:

```python
"""add user table

Revision ID: 0115a5b4e4a9
Revises: 
Create Date: 2024-03-29 10:00:00.000000

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '0115a5b4e4a9'
down_revision = None
branch_labels = None
depends_on = None

def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=50), nullable=True),
    sa.Column('email', sa.String(length=120), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('users')
    # ### end Alembic commands ###
```

This is a basic overview and example of using Alembic. In real-world scenarios, migrations might become more complex, and it's important to thoroughly test migrations before applying them in production environments.

##  How does FTAB support Alembic ?

FTAB supports Alembic's purpose —managing database schema changes through migrations— in several key ways:

1. **Automatic Migration Script Generation**: By invoking Alembic commands (`alembic revision --autogenerate -m "Add ${ResourceName} model"`), the script automatically generates migration scripts based on changes detected in the SQLAlchemy models. This eliminates the need for manually writing SQL scripts to alter the database schema when new models are added or existing models are modified. The autogenerate feature compares the current state of the database to the state defined in the models, and then generates a script to bridge any differences.

2. **Version Control for Database Schema**: Alembic maintains a version history of the database schema, enabling tracking of all changes made over time. This script integrates with this system by creating new revisions every time a resource is added, thereby updating the version history. This is crucial for understanding the evolution of the database schema, as well as for debugging and auditing purposes.

3. **Applying Migrations**: By running `alembic upgrade head`, the script applies the latest migration scripts to the database, ensuring that the database schema is up to date with the models defined in the code. This step moves the database from one version to another, safely applying schema changes.

4. **Dynamic Model Discovery**: The script updates Alembic's `env.py` file to include dynamic model discovery. This means that Alembic will automatically detect models defined in the project without the need for manual updates to migration scripts. This is achieved by modifying the `env.py` file to import the SQLAlchemy `Base` and all defined models, thus ensuring that Alembic considers all relevant models during migration generation and application.

5. **Seamless Integration into Development Workflow**: By integrating Alembic commands into the project setup script, Alembic becomes a seamless part of the development workflow. Developers can easily add new resources and immediately generate and apply the necessary migrations without switching contexts or manually running Alembic commands. This integration encourages consistent use of migrations and helps maintain database schema integrity.

Overall, the script leverages Alembic to ensure that the database schema evolves in a controlled and versioned manner alongside the application code, which is essential for maintaining database integrity, facilitating collaboration among developers, and supporting the deployment of changes in production environments.
